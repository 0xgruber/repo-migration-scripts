# Repository Migration Scripts

Complete toolkit for migrating repositories from GitLab to GitHub with automated discovery and configuration.

## Prerequisites

### Required Tools

| Tool | Purpose | Installation |
|------|---------|--------------|
| `git` | Repository operations | Usually pre-installed |
| `gh` | GitHub CLI for repo creation | See below |
| `curl` | API requests | `sudo dnf install curl` or `sudo apt install curl` |
| `jq` | JSON parsing | `sudo dnf install jq` or `sudo apt install jq` |
| `whiptail` | Interactive selection UI | `sudo dnf install newt` or `sudo apt install whiptail` |

### Installing GitHub CLI (gh)

**Fedora/RHEL/CentOS:**
```bash
sudo dnf install gh
```

**Ubuntu/Debian:**
```bash
sudo apt install gh
```

**macOS:**
```bash
brew install gh
```

**Other platforms:** https://cli.github.com/manual/installation

### Authenticating GitHub CLI

After installing, authenticate with your GitHub account:

```bash
gh auth login
```

You'll be prompted with several questions. Here's what to select:

```
? What account do you want to log into?
> GitHub.com                          # Select this for github.com

? What is your preferred protocol for Git operations on this host?
> SSH                                  # Select SSH (recommended for this migration)

? Upload your SSH public key to your GitHub account?
> /home/user/.ssh/id_ed25519.pub      # Select your SSH key, or skip if already uploaded

? Title for your SSH key:
> my-computer                          # Give it a descriptive name

? How would you like to authenticate GitHub CLI?
> Login with a web browser             # Easiest method - opens browser
                                       # Or "Paste an authentication token" if you have a PAT

? Press Enter to open github.com in your browser...
```

If using browser authentication:
1. Press Enter to open GitHub in your browser
2. Enter the one-time code shown in the terminal
3. Authorize the GitHub CLI application
4. Return to terminal - authentication is complete

**Verify authentication:**
```bash
gh auth status
```

Expected output:
```
github.com
  ‚úì Logged in to github.com account YOUR_USERNAME (keyring)
  - Active account: true
  - Git operations protocol: ssh
  - Token: gho_****
  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'
```

**Switch accounts (if needed):**
```bash
# Logout current account
gh auth logout

# Login with different account
gh auth login
```

### SSH Keys

Ensure SSH keys are configured for both GitLab and GitHub:

```bash
# Test GitLab access (replace with your GitLab host)
ssh -T git@gitlab.com

# Test GitHub access
ssh -T git@github.com
```

---

## Configuration Files

### config.ini

Main configuration file with credentials and paths:

```ini
[source]
host = gitlab.com              # Your GitLab host (gitlab.com or self-hosted)
user = your-gitlab-username
api_token = glpat-xxxxx        # GitLab Personal Access Token

[destination]
host = github.com
user = your-github-username

[paths]
work_dir = /tmp/repo-migration
local_repo_root = /home/user/code  # Root path for local repos

[local_repos]
# Repos to update locally (name only, or name|custom_path)
repos = my-project
    another-repo
    special-repo|/custom/path/to/repo

[options]
min_disk_space_mb = 5120
ssh_timeout = 5
verbose = true
```

### repos.ini

Auto-generated file containing repositories to migrate. Generated by `01-generate-repos.sh` with interactive selection:

```ini
[repositories]
my-project|private|My private project
public-repo|public|A public repository
# EXCLUDED: old-repo|internal|Repo I don't want to migrate
another-repo|internal|Internal project description
```

Format: `name|visibility|description`

Excluded repositories are commented with `# EXCLUDED:` prefix - remove the prefix to include them.

---

## Scripts Overview

| Script | Purpose |
|--------|---------|
| `01-generate-repos.sh` | Query GitLab API, interactive selection, generate repos.ini |
| `02-migrate-repos.sh` | Main migration script with URL update options |
| `03-update-local-remotes.sh` | Update local repo remotes to GitHub |
| `04-update-urls.sh` | Update GitLab URLs in code, config, and documentation |
| `05-archive-gitlab-repos.sh` | Archive repos on GitLab |
| `06-cleanup.sh` | Remove temporary files and directories |
| `07-deploy-security-workflow.sh` | Deploy GitHub Actions security scanning to all repos |
| `lib-config.sh` | Shared configuration library |

Each script prompts to run the next step when complete.

### Security Workflow

This toolkit includes a standard GitHub Actions security workflow that should be deployed to **all repositories** (current and future).

**Features:**
- üîí **Secret scanning** with Gitleaks (full git history)
- üêö **Shell script linting** with ShellCheck
- üì¶ **Dependency review** for pull requests
- ‚è∞ **Weekly scheduled scans**

**Deploy to all repositories:**
```bash
./07-deploy-security-workflow.sh
```

**For new repositories:** Copy `templates/security-workflow.yml` to `.github/workflows/security.yml`

**Documentation:** See [SECURITY-WORKFLOW.md](SECURITY-WORKFLOW.md) for full details.

---

## Quick Start

### 1. Configure

Edit `config.ini` with your settings:
- GitLab host, user, and API token
- GitHub user
- Local repo root path

### 2. Generate Repository List

Query GitLab and create `repos.ini` with interactive selection:

```bash
./01-generate-repos.sh
```

A checklist UI will appear to select which repositories to migrate. Deselected repos are kept as comments in `repos.ini` for reference.

Options:
- `--include-forks` - Include forked repositories
- `--archived` - Include archived repositories
- `--no-interactive` - Skip interactive selection (include all)
- `--output FILE` - Custom output file

### 3. Review repos.ini (Optional)

The interactive selection already filters repos, but you can manually edit if needed:

```bash
nano repos.ini  # Uncomment excluded repos or comment out others
```

### 4. Dry-Run Migration

Test without making changes:

```bash
./02-migrate-repos.sh --dry-run
```

### 5. Execute Migration

Run the actual migration:

```bash
./02-migrate-repos.sh
```

### 6. Post-Migration Steps

Each script prompts to run the next step, or run manually:

```bash
# Update local repos to point to GitHub
./03-update-local-remotes.sh

# Update URLs in code/config/documentation
./04-update-urls.sh

# Archive GitLab repos (optional)
./05-archive-gitlab-repos.sh

# Clean up temporary files
./06-cleanup.sh
```

---

## Detailed Usage

### 01-generate-repos.sh

Queries GitLab API to discover all your repositories and generates `repos.ini` with interactive selection:

```bash
# Basic usage - interactive checklist to select repos
./01-generate-repos.sh

# Include forked repositories
./01-generate-repos.sh --include-forks

# Include archived repositories
./01-generate-repos.sh --archived

# Skip interactive selection (include all repos)
./01-generate-repos.sh --no-interactive

# Custom output file
./01-generate-repos.sh --output custom-repos.ini
```

**Features:**
- Interactive checklist UI (whiptail) to select repositories
- Excluded repos saved as comments for reference
- Shows summary with included/excluded counts
- Prompts to run migration script when complete

---

### 02-migrate-repos.sh

Main migration script that:
1. Runs pre-flight checks (tools, auth, SSH, disk space)
2. Checks for uncommitted/unpushed changes in local repos
3. Prompts for URL update strategy (per-repo, batch, or skip)
4. Mirror clones each repository from GitLab
5. Creates corresponding repository on GitHub
6. Pushes complete history (branches, tags, commits)
7. Optionally updates GitLab URLs in code/docs
8. Generates detailed report

```bash
# Dry-run (preview only)
./02-migrate-repos.sh --dry-run

# Execute migration
./02-migrate-repos.sh

# Use custom config
./02-migrate-repos.sh --config /path/to/config.ini
```

**URL Update Options:**
When prompted, choose how to handle GitLab URLs in migrated repos:
1. **Per repository** - Review and update URLs after each repo migrates
2. **All at once** - Update all URLs after migration completes
3. **Skip** - Don't update URLs (can run `./04-update-urls.sh` later)

**Pre-flight checks:**
- Required commands (git, gh, curl, jq)
- GitHub CLI authentication
- SSH access to GitLab and GitHub
- Disk space availability
- Local repo status (uncommitted/unpushed changes)

**Output files:**
- `/tmp/repo-migration/migration.log` - Detailed log
- `/tmp/repo-migration/MIGRATION-REPORT.md` - Summary report

---

### 03-update-local-remotes.sh

Updates local git repositories to point to GitHub:

```bash
# Dry-run
./03-update-local-remotes.sh --dry-run

# Execute
./03-update-local-remotes.sh
```

**What it does:**
- Renames `origin` to `gitlab-backup`
- Adds new GitHub remote as `origin`
- Fetches from GitHub
- Sets upstream tracking

---

### 04-update-urls.sh

Updates GitLab URLs to GitHub URLs in ALL text files (code, config, documentation):

```bash
# Dry-run
./04-update-urls.sh --dry-run

# Interactive mode (review each change)
./04-update-urls.sh

# Auto-commit mode
./04-update-urls.sh --auto-commit
```

**File types scanned:**
- Code: `.py`, `.sh`, `.js`, `.ts`, `.go`, `.rs`, `.rb`, `.java`, `.c`, `.cpp`, `.h`
- Config: `.yml`, `.yaml`, `.json`, `.toml`, `.ini`, `.conf`, `.env`
- Docs: `.md`, `.rst`, `.txt`
- Build: `Dockerfile`, `Makefile`, `docker-compose.yml`
- And more...

**URL replacements:**
- `https://gitlab.com/user/*` ‚Üí `https://github.com/user/*`
- `git@gitlab.com:user/*` ‚Üí `git@github.com:user/*`
- Submodule URLs in `.gitmodules`

---

### 05-archive-gitlab-repos.sh

Archives migrated repositories on GitLab:

```bash
# Dry-run
./05-archive-gitlab-repos.sh --dry-run

# Execute (requires typing 'ARCHIVE' to confirm)
./05-archive-gitlab-repos.sh
```

**What it does:**
- Marks repositories as archived (read-only)
- Updates description with migration notice
- Adds link to new GitHub repository

---

## Troubleshooting

### GitHub CLI not authenticated

```bash
# Check status
gh auth status

# Re-authenticate
gh auth logout
gh auth login
```

### Wrong GitHub account

```bash
# Logout and login as correct user
gh auth logout
gh auth login
# Select the correct account when prompted
```

### SSH connection fails

```bash
# Test connections (replace gitlab.com with your GitLab host)
ssh -T git@gitlab.com
ssh -T git@github.com

# Check SSH config
cat ~/.ssh/config

# Check SSH keys
ssh-add -l
```

### Repository already exists on GitHub

```bash
# Delete existing repo
gh repo delete USER/REPO_NAME --yes

# Re-run migration
./02-migrate-repos.sh
```

### Large files fail to push

```bash
# Find large files
git rev-list --all --objects | \
  git cat-file --batch-check='%(objectsize) %(objectname) %(rest)' | \
  sort -nr | head -20

# Consider using Git LFS
git lfs migrate import --include="*.bin,*.zip" --everything
```

### Config parsing errors

Ensure `config.ini` format is correct:
- No tabs (use spaces)
- Section headers in brackets: `[section]`
- Key-value pairs: `key = value`
- Multi-line values indented with spaces

---

## Rollback

### Undo Local Remote Changes

```bash
cd /path/to/local/repo
git remote remove origin
git remote rename gitlab-backup origin
```

### Delete GitHub Repositories

```bash
gh repo delete USER/REPO_NAME --yes
```

### Unarchive GitLab Repositories

Via web UI: `https://gitlab.com/USER/REPO/edit`

Or via API:
```bash
curl -X POST --header "PRIVATE-TOKEN: $TOKEN" \
  "https://gitlab.com/api/v4/projects/ID/unarchive"
```

---

## File Structure

```
repo-migration-scripts/
‚îú‚îÄ‚îÄ config.ini.example          # Template configuration
‚îú‚îÄ‚îÄ config.ini                  # Your configuration (git-ignored)
‚îú‚îÄ‚îÄ repos.ini                   # Generated repository list (git-ignored)
‚îú‚îÄ‚îÄ lib-config.sh               # Shared config library
‚îú‚îÄ‚îÄ 01-generate-repos.sh        # Step 1: Generate repos.ini from GitLab
‚îú‚îÄ‚îÄ 02-migrate-repos.sh         # Step 2: Main migration script
‚îú‚îÄ‚îÄ 03-update-local-remotes.sh  # Step 3: Update local remotes
‚îú‚îÄ‚îÄ 04-update-urls.sh           # Step 4: Update URLs in code/config/docs
‚îú‚îÄ‚îÄ 05-archive-gitlab-repos.sh  # Step 5: Archive GitLab repos
‚îú‚îÄ‚îÄ 06-cleanup.sh               # Step 6: Remove temporary files
‚îî‚îÄ‚îÄ README.md                   # This file
```

---

## Post-Migration Checklist

- [ ] Generated repos.ini with interactive selection
- [ ] Ran dry-run migration successfully
- [ ] Executed migration
- [ ] Verified all repos on GitHub
- [ ] Updated local repository remotes
- [ ] Updated URLs in code/config/documentation
- [ ] Archived GitLab repositories
- [ ] Cleaned up temporary files
- [ ] Updated CI/CD configurations (if applicable)
- [ ] Notified team of new GitHub URLs

---

**Version:** 2.1  
**Updated:** 2026-01-05
